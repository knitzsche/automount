#!/bin/bash


function log(){
  echo -e "`date -Iseconds` ${1}" >> $LOG_SNAP_COMMON
}

# Outter loop ensures that the process continues after 
# insertion of USB with inapplicable content (for example no asserts and snaps)
# causes break on inner loop
while true
do
  # create watched file just to be sure
  [[ -n ${UNMOUNT} ]] && touch ${UNMOUNT}

  while true;
  do
    sleep 5
    #UNMOUNT is touched on USB unmount and its content is the mount point
    ${SNAP}/usr/bin/inotifywait -e open ${UNMOUNT}

    #MNT is the mountpoint of the USB drive
    MNT=`cat ${UNMOUNT}`

    echo -e "Unmount signal file ${UNMOUNT} touched. Unmountpoint is ${MNT}."
    MSG="\tMount signal file ${MOUNT} touched.\n\tMountpoint is ${MNT}.\n"
    log "${MSG}"
  done
done
